{% extends 'base.html' %}
{% load humanize %}

{% block title %}Agent: {{ agent.name }}{% endblock %}

{% block page_title %}Agent Tafsilotlari: {{ agent.name }}{% endblock %}

{% block content %}
<style>
    .card-header {
        background-color: #f8f9fc; /* Lighter grey for headers */
        border-bottom: 1px solid #e3e6f0;
        font-weight: 600; /* Slightly bolder headers */
    }
    .card.shadow {
        box-shadow: 0 .15rem 1.75rem 0 rgba(58,59,69,.1)!important; /* Softer shadow */
    }
    .table th {
        background-color: #f1f3f7; /* Light background for table headers */
        font-weight: 600;
    }
    .badge {
        font-size: 0.8em;
        padding: 0.4em 0.7em;
    }
    .border-left-danger {
        border-left: .25rem solid #e74a3b!important;
    }
    .text-xs {
        font-size: .7rem;
    }
    .agent-info-card .card-body {
        display: flex;
        flex-direction: column;
    }
    .agent-info-card .agent-details p {
        margin-bottom: 0.5rem; /* Tighter spacing for agent details */
    }
    .agent-info-card .agent-notes {
        margin-top: auto; /* Pushes notes to the bottom */
        padding-top: 0.5rem;
        font-style: italic;
    }
    .partially-paid {
        background-color: #fff3cd; /* Light yellow for partially paid rows */
    }
    .fully-paid {
        background-color: #d1e7dd; /* Light green for fully paid rows */
    }
    .not-paid {
        background-color: #f8d7da; /* Light red for not paid rows */
    }
    .price-col-detail .col {
        padding: 0.35rem 0.5rem; 
        font-size: 0.875em; 
        line-height: 1.3;
    }
    .price-col-detail .col:first-child { /* UZS */
        border-right: 1px solid #e3e6f0;
    }
    .table tfoot td {
        font-weight: bold;
        background-color: #f1f3f7; /* Same as thead for consistency */
    }
</style>
<div class="container-fluid">
    {% comment %} Display Django Messages {% endcomment %}
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <!-- Agent Information Column -->
        <div class="col-xl-4 col-lg-5 mb-4">
            <div class="card shadow h-100 agent-info-card">
                <div class="card-header py-3">
                    <h6 class="m-0 text-primary"><i class="fas fa-address-card me-2"></i>Agent Ma'lumotlari</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-user-tie fa-3x text-gray-400 me-3"></i>
                        <div>
                            <h4 class="mb-0 font-weight-bold text-gray-800">{{ agent.name }}</h4>
                        </div>
                    </div>
                    <div class="agent-details">
                        <p><strong>Telefon:</strong> {{ agent.phone_number|default:"N/A" }}</p>
                        <p><strong>Qo'shilgan sana:</strong> {{ agent.created_at|date:"d.m.Y H:i" }}</p>
                    </div>
                    {% if agent.notes %}
                        <p class="card-text agent-notes"><small class="text-muted"><strong>Izohlar:</strong> {{ agent.notes }}</small></p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Debt Information Column -->
        <div class="col-xl-8 col-lg-7 mb-4">
            <div class="row">
                <div class="col-md-6 mb-4 mb-md-0">
                    <div class="card border-left-danger shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                        Jami Qarz (UZS)</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">{{ agent.outstanding_balance_uzs|floatformat:"0"|intcomma }} UZS</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-file-invoice-dollar fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-left-danger shadow h-100 py-2">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                        Jami Qarz (USD)</div>
                                    <div class="h5 mb-0 font-weight-bold text-gray-800">${{ agent.outstanding_balance_usd|floatformat:"2"|intcomma }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-file-invoice-dollar fa-2x text-gray-300"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 text-primary"><i class="fas fa-list-alt me-2"></i>Agentga Qilingan Sotuvlar (Qarzlar)</h6>
            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                <i class="fas fa-hand-holding-usd me-1"></i> To'lov Qilish
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle" id="agentSalesTable" width="100%" cellspacing="0">
                    <thead class="table-light">
                        <tr class="border-bottom border-2">
                            <th class="py-3 px-2">ID</th>
                            <th class="py-3 px-2">Sana</th>
                            <th class="py-3 px-2">Chipta</th>
                            <th class="py-3 px-2 text-center">Miqdori</th>
                            <th class="py-3 px-2 text-center price-col-detail">Jami Sotuv (Qarz)
                                <div class="container-fluid gx-0"><div class="row gx-0">
                                    <div class="col text-center small py-1">UZS</div><div class="col text-center small py-1">USD</div>
                                </div></div>
                            </th>
                            <th class="py-3 px-2 text-center price-col-detail">To'langan (Sotuvga)
                                <div class="container-fluid gx-0"><div class="row gx-0">
                                    <div class="col text-center small py-1">UZS</div><div class="col text-center small py-1">USD</div>
                                </div></div>
                            </th>
                            <th class="py-3 px-2 text-center price-col-detail fw-bold">Qoldiq (Sotuv Bo'yicha)
                                <div class="container-fluid gx-0"><div class="row gx-0">
                                    <div class="col text-center small py-1">UZS</div><div class="col text-center small py-1">USD</div>
                                </div></div>
                            </th>
                            <th class="py-3 px-2 text-center">Holati</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sale in agent_sales %}
                        <tr class="{% if sale.is_fully_paid %}fully-paid{% elif sale.paid_amount_on_this_sale > 0 %}partially-paid{% else %}not-paid{% endif %}">
                            <td class="py-2 px-2">{{ sale.id }}</td>
                            <td class="py-2 px-2">{{ sale.sale_date|date:"d.m.y H:i" }}</td>
                            <td class="py-2 px-2">
                                {{ sale.related_acquisition.ticket.description|truncatewords:5 }}
                                <small class="text-muted d-block">(Acq.ID: {{ sale.related_acquisition.id }})</small>
                            </td>
                            <td class="py-2 px-2 text-center">{{ sale.quantity|intcomma }}</td>
                            <td class="py-2 px-0 price-col-detail">
                                <div class="container-fluid gx-0"><div class="row gx-0">
                                    <div class="col text-end">{% if sale.sale_currency == 'UZS' %}{{ sale.total_sale_amount|floatformat:0|intcomma }}{% else %}-{% endif %}</div>
                                    <div class="col text-end">{% if sale.sale_currency == 'USD' %}${{ sale.total_sale_amount|floatformat:2|intcomma }}{% else %}-{% endif %}</div>
                                </div></div>
                            </td>
                            <td class="py-2 px-0 price-col-detail">
                                <div class="container-fluid gx-0"><div class="row gx-0">
                                    <div class="col text-end">{% if sale.sale_currency == 'UZS' %}{{ sale.paid_amount_on_this_sale|floatformat:0|intcomma }}{% else %}-{% endif %}</div>
                                    <div class="col text-end">{% if sale.sale_currency == 'USD' %}${{ sale.paid_amount_on_this_sale|floatformat:2|intcomma }}{% else %}-{% endif %}</div>
                                </div></div>
                            </td>
                            <td class="py-2 px-0 price-col-detail fw-bold">
                                <div class="container-fluid gx-0"><div class="row gx-0">
                                    <div class="col text-end">
                                        {% if sale.sale_currency == 'UZS' %}
                                            {{ sale.total_sale_amount|floatformat:0|intcomma }}
                                            {% if sale.paid_amount_on_this_sale >= 0 %}
                                                <small class="text-muted d-block">(To'langan: {{ sale.paid_amount_on_this_sale|floatformat:0|intcomma }})</small>
                                            {% endif %}
                                        {% else %}-{% endif %}
                                    </div>
                                    <div class="col text-end">
                                        {% if sale.sale_currency == 'USD' %}
                                            ${{ sale.total_sale_amount|floatformat:2|intcomma }}
                                            {% if sale.paid_amount_on_this_sale >= 0 %}
                                                <small class="text-muted d-block">(To'langan: ${{ sale.paid_amount_on_this_sale|floatformat:2|intcomma }})</small>
                                            {% endif %}
                                        {% else %}-{% endif %}
                                    </div>
                                </div></div>
                            </td>
                            <td class="py-2 px-2 text-center">
                                {% if sale.is_fully_paid %}
                                    <span class="badge bg-success">To'liq To'langan</span>
                                {% elif sale.paid_amount_on_this_sale > 0 %}
                                    <span class="badge bg-warning text-dark">Qisman To'langan</span>
                                {% else %}
                                    <span class="badge bg-danger">To'lanmagan</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-3 px-3">Bu agent uchun hali aktiv sotuvlar (qarzlar) mavjud emas.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="6" class="text-end"><strong>Jami Qoldiq:</strong></td>
                            <td class="py-2 px-0 price-col-detail text-end fw-bolder">
                                <div class="container-fluid gx-0"><div class="row gx-0">
                                     <div class="col text-end">{{ agent.outstanding_balance_uzs|floatformat:0|intcomma }}</div>
                                     <div class="col text-end">${{ agent.outstanding_balance_usd|floatformat:2|intcomma }}</div>
                                </div></div>
                            </td>
                            <td class="text-center"> <!-- Empty cell for status column -->
                                <i class="fas fa-calculator text-primary"></i>
                            </td> 
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Agent Payments History (Remains mostly the same) -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 text-primary"><i class="fas fa-history me-2"></i>Agent To'lovlari Tarixi</h6>
        </div>
        <div class="card-body">
            {% if agent_payments %}
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle" id="agentPaymentsTable" width="100%" cellspacing="0">
                    <thead class="table-light">
                        <tr>
                            <th class="py-3 px-3">To'lov Sanasi</th>
                            <th class="py-3 px-3">Aloqador Sotuv ID</th>
                            <th class="py-3 px-3 text-end">Summa (UZS)</th>
                            <th class="py-3 px-3 text-end">Summa (USD)</th>
                            <th class="py-3 px-3">To'langan Hisob</th>
                            <th class="py-3 px-3">Izoh</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for payment in agent_payments %}
                        <tr>
                            <td class="py-2 px-3">{{ payment.payment_date|date:"d.m.Y H:i" }}</td>
                            <td class="py-2 px-3 text-center">{% if payment.related_sale %}{{ payment.related_sale.id }}{% else %}-{% endif %}</td>
                            <td class="py-2 px-3 text-end">{{ payment.amount_paid_uzs|floatformat:"0"|intcomma|default_if_none:"-" }}</td>
                            <td class="py-2 px-3 text-end">{% if payment.amount_paid_usd %}${{ payment.amount_paid_usd|floatformat:"2"|intcomma }}{% else %}-{% endif %}</td>
                            <td class="py-2 px-3">{{ payment.paid_to_account.name }}</td>
                            <td class="py-2 px-3">{{ payment.notes|default:"-"|truncatewords:10 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted">Agent uchun hali to'lovlar amalga oshirilmagan.</p>
            {% endif %}
        </div>
    </div>

    <div class="mt-4 mb-3">
        <a href="{% url 'contacts:agent-list' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left me-1"></i> Agentlar Ro'yxatiga Qaytish
        </a>
    </div>

</div>

<!-- Add Payment Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{% url 'contacts:agent-add-payment' agent_pk=agent.pk %}" id="agentPaymentModalForm">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title" id="addPaymentModalLabel">Agent To'lovini Qo'shish: {{ agent.name }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% if payment_form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in payment_form.non_field_errors %}
                                <p class="mb-0">{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% for field in payment_form %}
                        <div class="mb-3 row" id="div_{{ field.auto_id }}">
                            <label for="{{ field.id_for_label }}" class="col-sm-4 col-form-label col-form-label-sm text-sm-end">
                                {{ field.label }}
                                {% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            <div class="col-sm-8">
                                {{ field }} 
                                {% if field.help_text %}
                                    <small class="form-text text-muted d-block mt-1">{{ field.help_text }}</small>
                                {% endif %}
                                {% for error in field.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                     <div class="alert alert-info alert-dismissible fade show mt-3" role="alert" id="paymentModalInfo">
                        <small>
                            <strong>Eslatma:</strong> Ma'lum bir sotuv uchun to'lov qilmoqchi bo'lsangiz, yuqoridan sotuvni tanlang. Shunda to'lov summasi va valyutasi avtomatik cheklanadi.
                            Aks holda, umumiy qarzga to'lov sifatida kiritiladi.
                        </small>
                         <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Bekor Qilish</button>
                    <button type="submit" class="btn btn-primary btn-sm">Saqlash</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const paymentForm = document.getElementById('agentPaymentModalForm');
    if (!paymentForm) return;

    const relatedSaleSelect = paymentForm.querySelector('[name="related_sale"]');
    const amountUzsInput = paymentForm.querySelector('[name="amount_paid_uzs"]');
    const amountUsdInput = paymentForm.querySelector('[name="amount_paid_usd"]');
    const paidToAccountSelect = paymentForm.querySelector('[name="paid_to_account"]');
    
    let originalAccountOptions = [];

    function buildOriginalAccountOptions() {
        originalAccountOptions = [];
        if (paidToAccountSelect) {
            Array.from(paidToAccountSelect.options).forEach(opt => {
                if (opt.value) {
                    let currency = 'USD';
                    if (opt.text.includes('(UZS)')) {
                        currency = 'UZS';
                    } else if (opt.text.includes('(USD)')) {
                        currency = 'USD';
                    } else {
                        if (opt.text.toLowerCase().includes('sum') || opt.text.toLowerCase().includes('so\'m') || opt.text.toLowerCase().includes('uzs')) {
                            currency = 'UZS';
                        } else if (opt.text.toLowerCase().includes('dollar') || opt.text.toLowerCase().includes('usd')) {
                            currency = 'USD';
                        }
                    }
                    originalAccountOptions.push({ value: opt.value, text: opt.text, currency: currency });
                }
            });
        }
    }

    if (paidToAccountSelect) {
        buildOriginalAccountOptions();
    }

    function updatePaymentFormForSale() {
        if (!relatedSaleSelect || !amountUzsInput || !amountUsdInput || !paidToAccountSelect) {
            return;
        }

        amountUzsInput.value = '0';
        amountUsdInput.value = '0';
        amountUzsInput.disabled = true;
        amountUsdInput.disabled = true;
        paidToAccountSelect.disabled = false;

        const selectedOption = relatedSaleSelect.options[relatedSaleSelect.selectedIndex];
        if (!selectedOption || !selectedOption.value) {
            filterAccountOptionsByCurrency(null);
            return;
        }

        const saleText = selectedOption.text;
        const balanceMatch = saleText.match(/Balans: ([\d,\.]+) (UZS|USD)/);
        
        if (!balanceMatch) {
            filterAccountOptionsByCurrency(null);
            return;
        }

        const balance = parseFloat(balanceMatch[1].replace(/,/g, ''));
        const currency = balanceMatch[2];

        if (currency === 'UZS') {
            if(amountUzsInput) {
                amountUzsInput.value = balance.toFixed(0);
                amountUzsInput.max = balance.toFixed(0);
                amountUzsInput.disabled = false;
            }
            if(amountUsdInput) {
                amountUsdInput.value = '';
                amountUsdInput.disabled = true;
            }
        } else if (currency === 'USD') {
            if(amountUsdInput) {
                amountUsdInput.value = balance.toFixed(2);
                amountUsdInput.max = balance.toFixed(2);
                amountUsdInput.disabled = false;
            }
            if(amountUzsInput) {
                amountUzsInput.value = '';
                amountUzsInput.disabled = true;
            }
        }
        filterAccountOptionsByCurrency(currency);
    }

    function filterAccountOptionsByCurrency(targetCurrency) {
        if (!paidToAccountSelect) {
            return;
        }
        const previouslySelectedValue = paidToAccountSelect.value;
        paidToAccountSelect.innerHTML = '<option value="">---------</option>';

        originalAccountOptions.forEach(opt => {
            if (!targetCurrency || opt.currency === targetCurrency) {
                const option = document.createElement('option');
                option.value = opt.value;
                option.text = opt.text;
                paidToAccountSelect.appendChild(option);
            }
        });

        let foundPrevious = false;
        for (let i = 0; i < paidToAccountSelect.options.length; i++) {
            if (paidToAccountSelect.options[i].value === previouslySelectedValue) {
                paidToAccountSelect.selectedIndex = i;
                foundPrevious = true;
                break;
            }
        }
        if (!foundPrevious) {
            paidToAccountSelect.selectedIndex = 0;
        }
    }

    if (relatedSaleSelect) {
        relatedSaleSelect.addEventListener('change', updatePaymentFormForSale);
        if(amountUzsInput) amountUzsInput.dataset.originalValue = amountUzsInput.value;
        if(amountUsdInput) amountUsdInput.dataset.originalValue = amountUsdInput.value;
        
        if (relatedSaleSelect.value) {
            updatePaymentFormForSale();
        } else {
            filterAccountOptionsByCurrency(null);
        }
    }
    
    if (amountUzsInput) {
        amountUzsInput.addEventListener('input', () => {
            if (!relatedSaleSelect || !relatedSaleSelect.value) { 
                if (parseFloat(amountUzsInput.value) > 0) {
                    if(amountUsdInput) amountUsdInput.value = '';
                    filterAccountOptionsByCurrency('UZS');
                } else if (amountUsdInput && !parseFloat(amountUzsInput.value) > 0) {
                    filterAccountOptionsByCurrency(null); 
                }
            }
        });
    }
    if (amountUsdInput) {
        amountUsdInput.addEventListener('input', () => {
            if (!relatedSaleSelect || !relatedSaleSelect.value) { 
                if (parseFloat(amountUsdInput.value) > 0) {
                    if(amountUzsInput) amountUzsInput.value = '';
                    filterAccountOptionsByCurrency('USD');
                } else if (amountUzsInput && !parseFloat(amountUzsInput.value) > 0) {
                    filterAccountOptionsByCurrency(null); 
                }
            }
        });
    }
    
    var addPaymentModalElement = document.getElementById('addPaymentModal');
    if (addPaymentModalElement) {
        addPaymentModalElement.addEventListener('shown.bs.modal', function () {
            buildOriginalAccountOptions();
            if (relatedSaleSelect && relatedSaleSelect.value) {
                 updatePaymentFormForSale();
            } else {
                let currentAmountCurrency = null;
                if (amountUzsInput && parseFloat(amountUzsInput.value) > 0) currentAmountCurrency = 'UZS';
                else if (amountUsdInput && parseFloat(amountUzsInput.value) > 0) currentAmountCurrency = 'USD';
                filterAccountOptionsByCurrency(currentAmountCurrency);
            }
        });
    }

});
</script>
{% endblock extra_js %}